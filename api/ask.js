// api/ask.js - ุงูุฎุงุฏู ุงูุฎููู ูููุณุงุนุฏ ุงูููุฏุณู
// ูุฐุง ููู ูุนูู ุนูู Vercel Serverless Functions

export default async function handler(req, res) {
  // ุชูุนูู ุงูู CORS ููุณูุงุญ ููููุนู ุจุงูุงุชุตุงู
  res.setHeader('Access-Control-Allow-Credentials', true);
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  // ุงูุชุนุงูู ูุน ุทูุจุงุช OPTIONS ุงูุฎุงุตุฉ ุจู CORS
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  // ููุทุฉ ููุชุญูู ูู ุตุญุฉ ุงูุฎุงุฏู
  if (req.method === 'GET') {
    return res.status(200).json({
      status: 'โ ุงูุฎุงุฏู ูุนูู',
      message: 'ูุฑุญุจุงู ุจู ูู ุงููุณุงุนุฏ ุงูููุฏุณู ููุทูุงุจ ุงูุนุฑุงูููู',
      hasApiKey: !!process.env.ANTHROPIC_API_KEY,
      timestamp: new Date().toISOString(),
      instructions: process.env.ANTHROPIC_API_KEY 
        ? 'ุชู ุชูุนูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู! ๐' 
        : 'ุฃุถู ANTHROPIC_API_KEY ูู ุฅุนุฏุงุฏุงุช Vercel ูุชูุนูู Claude AI'
    });
  }

  // ุงูุชุนุงูู ูุน ุทูุจุงุช ุงูุฃุณุฆูุฉ (POST)
  if (req.method === 'POST') {
    try {
      const { image, fileType, specialty, subject, additionalText } = req.body;

      // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
      if (!specialty || !subject) {
        return res.status(400).json({
          success: false,
          message: 'โ ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงูุชุฎุตุต ูุงููุงุฏุฉ ุงูุฏุฑุงุณูุฉ'
        });
      }

      console.log(`๐ฅ ุชู ุงุณุชูุจุงู ุณุคุงู ูู: ${specialty} - ${subject}`);

      // ๐ ุงูุญุงูุฉ 1: ุฅุฐุง ูุงู ููุงู API Key ุญูููู - ูุณุชุฎุฏู Claude AI
      if (process.env.ANTHROPIC_API_KEY) {
        const apiKey = process.env.ANTHROPIC_API_KEY;
        
        if (!image) {
          return res.status(400).json({
            success: false,
            message: 'โ ุงูุฑุฌุงุก ุฑูุน ุตูุฑุฉ ููุณุคุงู'
          });
        }

        // ุจูุงุก ุงูู Prompt ุงูุฃูุงุฏููู
        const prompt = `ุฃูุช ุฃุณุชุงุฐ ุฌุงูุนู ุนุฑุงูู ูุชุฎุตุต ูู ${specialty}ุ ูุชูุฏุฑูุณ ูุงุฏุฉ "${subject}" ุถูู ุงููููุงุฌ ุงูุนุฑุงูู.

ุงูุทุงูุจ ุฑูุน ุตูุฑุฉ ุชุญุชูู ุนูู ุณุคุงู ุฃู ุชูุฑูู. ุจูุงุกู ุนูู ุชุฎุตุตู ูุฎุจุฑุชู:

1. ุญูู ุงูุณุคุงู ูู ุงูุตูุฑุฉ ุจุฏูุฉ
2. ูุฏู ุงูุฅุฌุงุจุฉ ุจุฃุณููุจ ุฃูุงุฏููู ูุงุถุญ ูููุธู
3. ุงุณุชุฎุฏู ุงููุฑุงุฌุน ูุงููุนุงุฏูุงุช ุงููุนุชูุฏุฉ ูู ุงูููุงูุฌ ุงูุนุฑุงููุฉ
4. ุงุดุฑุญ ุงูุฎุทูุงุช ุงูุญูููุฉ ุจุงูุชูุตูู
5. ูุฏู ูุตุงุฆุญ ุนูููุฉ ููุทุงูุจ

${additionalText ? `ููุงุญุธุงุช ุงูุทุงูุจ ุงูุฅุถุงููุฉ: ${additionalText}\n\n` : ''}
ุฃุฌุจ ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุงููุตุญูุ ูุฑูุฒ ุนูู ุงููุถูุญ ูุงูุฏูุฉ.`;

        // ุงูุงุชุตุงู ุจู Claude API
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01'
          },
          body: JSON.stringify({
            model: 'claude-3-sonnet-20240229',
            max_tokens: 4000,
            messages: [
              {
                role: 'user',
                content: [
                  image ? {
                    type: 'image',
                    source: {
                      type: 'base64',
                      media_type: fileType || 'image/jpeg',
                      data: image
                    }
                  } : null,
                  {
                    type: 'text',
                    text: prompt
                  }
                ].filter(Boolean) // ุฅุฒุงูุฉ ุงูุนูุงุตุฑ ุงููุงุฑุบุฉ
              }
            ]
          })
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('โ ุฎุทุฃ ูู Claude API:', errorText);
          
          // ุชูุฏูู ุฑุฏ ุจุฏูู
          return res.json({
            success: true,
            answer: `# ๐ง ุชู ุงุณุชูุจุงู ุณุคุงูู ูู ${specialty}

## ๐ ุงููุงุฏุฉ: ${subject}

ูุนุชุฐุฑุ ุญุฏุซ ุฎุทุฃ ุชููู ุฃุซูุงุก ุงูุงุชุตุงู ุจูุธุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู.

### ๐ก ูุง ููููู ูุนูู:
1. ุชุญูู ูู ุงุชุตุงู ุงูุฅูุชุฑูุช
2. ุญุงูู ูุฑุฉ ุฃุฎุฑู ุจุนุฏ ูููู
3. ุชุฃูุฏ ูู ูุถูุญ ุงูุตูุฑุฉ ุงููุฑููุนุฉ

**ุชูุงุตูู ุงูุฎุทุฃ:** ${response.status} - ${response.statusText}

---
*ููุญุตูู ุนูู ูุณุงุนุฏุฉ ููุฑูุฉุ ููููู ูุฑุงุฌุนุฉ ูุญุงุถุฑุงุช ูุงุฏุฉ ${subject} ูู ุงููููุงุฌ ุงูุนุฑุงูู.*`,
            isMock: false,
            error: true
          });
        }

        const data = await response.json();
        const answer = data.content
          .filter(item => item.type === 'text')
          .map(item => item.text)
          .join('\n\n');

        return res.json({
          success: true,
          answer: answer,
          model: data.model,
          tokens: data.usage?.total_tokens || 0,
          isMock: false,
          timestamp: new Date().toLocaleString('ar-IQ')
        });

      } 
      // ๐ ุงูุญุงูุฉ 2: ูุง ููุฌุฏ API Key - ูุณุชุฎุฏู ุงูุฑุฏ ุงูุชุฌุฑูุจู
      else {
        // ุฑุฏูุฏ ุชุฌุฑูุจูุฉ ุญุณุจ ุงูุชุฎุตุต
        const mockResponses = {
          petroleum: `# ๐ข๏ธ ููุฏุณุฉ ุงูููุท ูุงูุบุงุฒ - ${subject}

## ๐ ุฅุฌุงุจุฉ ุฃูุงุฏูููุฉ (ุชุฌุฑูุจูุฉ)

ุจูุงุกู ุนูู ุงููููุงุฌ ุงูุนุฑุงูู ูุทูุจุฉ **ููุฏุณุฉ ุงูููุท**ุ ุฅููู ุงูุชุญููู ุงููููุฌู ููุณุคุงู:

### ๐ **ุงูุฎุทูุงุช ุงูุฃุณุงุณูุฉ ููุญู:**
1. **ุชุญุฏูุฏ ุงููุนุทูุงุช:** ูู ุงูุตูุฑุฉ ุงููุฑููุนุฉ
2. **ุงุฎุชูุงุฑ ุงููููุฐุฌ ุงูุญุณุงุจู:** ููู ุงูููุฏ ุงูุนุฑุงูู
3. **ุชุทุจูู ุงููุนุงุฏูุงุช:** ูุน ูุฑุงุนุงุฉ ุงููุญุฏุงุช (ุจุงุฑุ ูุชุฑ ููุนุจุ ุฏุฑุฌุฉ ูุฆููุฉ)
4. **ุงูุชุญูู ูู ุงููุชุงุฆุฌ:** ุจููุงุฑูุชูุง ูุน ุงูุฌุฏุงูู ุงูููุงุณูุฉ ุงูุนุฑุงููุฉ

### ๐ง **ูุนุงุฏูุฉ ุฃุณุงุณูุฉ ูู ${subject}:**
\`\`\`
ูุนุฏู ุงูุฅูุชุงุฌ = (ุงูููุงุฐูุฉ ร ูุฑู ุงูุถุบุท ร ุงูุณูุงูุฉ) / (ูุฒูุฌุฉ ุงูุณุงุฆู ร ุนุงูู ุงูุชุตุญูุญ)
\`\`\`

### ๐ **ุงููุฑุงุฌุน ุงูุนุฑุงููุฉ ุงูููุตู ุจูุง:**
- "ููุฏุณุฉ ุงูููุงูู ุงูููุทูุฉ" - ุฏ. ุนูู ุนุจุฏุงููู (ุฌุงูุนุฉ ุงูุจุตุฑุฉ)
- "ุญูุฑ ุงูุขุจุงุฑ" - ุงููููุงุฌ ุงููุฒุงุฑู ุงูุนุฑุงูู
- ุฌุฏุงูู ุงูููุงุตูุงุช ุงูููุงุณูุฉ ุงูุนุฑุงููุฉ ููุฒูุช ุงูุฎุงู

### ๐ก **ูุตูุญุฉ ุนูููุฉ ููุทุงูุจ ุงูุนุฑุงูู:**
"ุฑุงุฌุน ุฃูุซูุฉ ุงูุงูุชุญุงูุงุช ุงูููุงุฆูุฉ ููุณููุงุช 2020-2023 ุงููุชููุฑุฉ ูู ููุชุจุฉ ูููุชูุ ุญูุซ ุชุฑูุฒ ุจุดูู ูุจูุฑ ุนูู ${subject}."

---
**โ๏ธ ููุงุญุธุฉ:** ูุฐู ุฅุฌุงุจุฉ ุชูุถูุญูุฉ. ูุชูุนูู **ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงูุญูููู** ุงูุฐู ูุญูู ุตูุฑุชู ุจุฏูุฉ:
1. ุงุญุตู ุนูู ููุชุงุญ API ูู anthropic.com
2. ุฃุถูู ูู ุฅุนุฏุงุฏุงุช Vercel โ Environment Variables
3. ุฃุนุฏ ูุดุฑ ุงููููุน`,
          
          electrical: `# โก ุงูููุฏุณุฉ ุงูููุฑุจุงุฆูุฉ - ${subject}

## ๐ ุฅุฌุงุจุฉ ูููุฌูุฉ (ุชุฌุฑูุจูุฉ)

### ๐ **ูููุฌูุฉ ุญู ูุณุงุฆู ${subject}:**
1. ุฑุณู ุงูุฏุงุฆุฑุฉ ุงูููุฑุจุงุฆูุฉ ูู ุงููุนุทูุงุช
2. ุชุทุจูู ูุงููู ููุฑุดูู ููุฌููุฏ ุฃู ุงูุชูุงุฑุงุช
3. ุญุณุงุจ ุงูููุงููุฉ ุงูููุงูุฆุฉ
4. ุงุณุชุฎุฏุงู ูุงููู ุฃูู: \`V = I ร R\`
5. ุงูุชุญูู ุจูุญุฏุงุช ุงููุธุงู ุงูุฏููู (SI)

---
*ููุญุตูู ุนูู ุฅุฌุงุจุฉ ุฐููุฉ ุชุญูู ุตูุฑุชูุ ุฃุถู ููุชุงุญ API.*`,
          
          mechanical: `# โ๏ธ ุงูููุฏุณุฉ ุงููููุงููููุฉ - ${subject}

## ๐ญ ุฅุฌุงุจุฉ ููุฏุณูุฉ (ุชุฌุฑูุจูุฉ)

### ๐ก๏ธ **ููุณุงุฆู ุงูุฏููุงูููุง ุงูุญุฑุงุฑูุฉ:**
\`\`\`
ุงูููุงุกุฉ = (ุงูุดุบู ุงููุงุชุฌ) / (ุงูุญุฑุงุฑุฉ ุงูุฏุงุฎูุฉ) ร 100%
\`\`\`

---
*ููุญุตูู ุนูู ุฅุฌุงุจุฉ ุฐููุฉ ุชุญูู ุตูุฑุชูุ ุฃุถู ููุชุงุญ API.*`,
          
          civil: `# ๐๏ธ ุงูููุฏุณุฉ ุงููุฏููุฉ - ${subject}

## ๐ข ุฅุฌุงุจุฉ ุฅูุดุงุฆูุฉ (ุชุฌุฑูุจูุฉ)

### ๐ **ูุญุณุงุจุงุช ุฅุฌูุงุฏุงุช ุงูุฎุฑุณุงูุฉ:**
\`\`\`
ุงูุฅุฌูุงุฏ ุงููุณููุญ = 0.45 ร ููุงููุฉ ุชูุณุฑ ุงูููุนุจ
\`\`\`

---
*ููุญุตูู ุนูู ุฅุฌุงุจุฉ ุฐููุฉ ุชุญูู ุตูุฑุชูุ ุฃุถู ููุชุงุญ API.*`
        };

        const selectedSpecialty = specialty.toLowerCase().includes('ููุท') ? 'petroleum' : 
                                specialty.toLowerCase().includes('ููุฑุจ') ? 'electrical' :
                                specialty.toLowerCase().includes('ูููุงููู') ? 'mechanical' : 'civil';

        return res.json({
          success: true,
          answer: mockResponses[selectedSpecialty] || mockResponses.petroleum,
          model: 'claude-3-sonnet-20240229 (ุงููุถุน ุงูุชุฌุฑูุจู)',
          tokens: 250,
          isMock: true,
          note: '๐ง ูุฐู ุฅุฌุงุจุฉ ุชุฌุฑูุจูุฉ. ุฃุถู ANTHROPIC_API_KEY ูู ุฅุนุฏุงุฏุงุช Vercel ูุชูุนูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงูุญูููู ุงูุฐู ูุญูู ุตูุฑุชู.',
          nextSteps: [
            '1. ุณุฌู ูู anthropic.com ูุงุญุตู ุนูู ููุชุงุญ API ูุฌุงูู',
            '2. ูู Vercel: Settings โ Environment Variables โ Add New',
            '3. ุงูุงุณู: ANTHROPIC_API_KEYุ ุงููููุฉ: ููุชุงุญู',
            '4. ุฃุนุฏ ุงููุดุฑ (Redeploy)'
          ]
        });
      }

    } catch (error) {
      console.error('๐ฅ ุฎุทุฃ ูู ุงูุฎุงุฏู:', error);
      
      return res.status(500).json({
        success: false,
        message: 'ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน ูู ุงูุฎุงุฏู',
        error: process.env.NODE_ENV === 'development' ? error.message : 'ุชูุงุตูู ุงูุฎุทุฃ ูุฎููุฉ ูู ูุถุน ุงูุฅูุชุงุฌ',
        tip: 'ุญุงูู ูุฑุฉ ุฃุฎุฑู ุฃู ุชุญูู ูู ุงุชุตุงู ุงูุดุจูุฉ'
      });
    }
  }

  // ุฅุฐุง ูุตููุง ููุงุ ุงูุทูุจ ุบูุฑ ูุนุฑูู
  return res.status(404).json({
    success: false,
    message: 'โ ููุทุฉ ุงูููุงูุฉ ุบูุฑ ููุฌูุฏุฉ',
    availableEndpoints: {
      'GET /api/ask': 'ููุชุญูู ูู ุตุญุฉ ุงูุฎุงุฏู',
      'POST /api/ask': 'ูุฅุฑุณุงู ุงูุฃุณุฆูุฉ ูุงูุตูุฑ'
    }
  });
}